<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>class nbla::SwapInOutScheduler &mdash; Neural Network Libraries 1.33.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="class Swish" href="Swish.html" />
    <link rel="prev" title="class nbla::SumPooling" href="nbla--SumPooling.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Neural Network Libraries
          </a>
              <div class="version">
                1.33.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../python.html">Python Package</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../cpp.html">C++ API</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../installation.html">Build C++ libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../command_line_interface.html">C++ Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html">C++ API Examples</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../doc.html">C++ API Document</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../../cpp_api.html">NNABLA C++ API Document</a><ul class="current">
<li class="toctree-l4 current"><a class="reference internal" href="../class.html">NNABLA Class</a></li>
<li class="toctree-l4"><a class="reference internal" href="../struct.html">NNABLA Struct</a></li>
<li class="toctree-l4"><a class="reference internal" href="../namespace.html">NNABLA Namespace</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_exchange_file_format.html">Data exchange file format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../format.html">Data Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/file_format_converter/file_format_converter.html">File format converter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../support_status.html">Support Status</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Neural Network Libraries</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../../cpp.html">C++ API</a></li>
          <li class="breadcrumb-item"><a href="../../doc.html">C++ API Document</a></li>
          <li class="breadcrumb-item"><a href="../../cpp_api.html">NNABLA C++ API Document</a></li>
          <li class="breadcrumb-item"><a href="../class.html">NNABLA Class</a></li>
      <li class="breadcrumb-item active">class nbla::SwapInOutScheduler</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/cpp/Cpp/class/nbla--SwapInOutScheduler.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="class-nbla-swapinoutscheduler">
<h1>class nbla::SwapInOutScheduler<a class="headerlink" href="#class-nbla-swapinoutscheduler" title="Permalink to this headline"></a></h1>
<dl class="cpp class">
<dt class="sig sig-object cpp" id="_CPPv4N4nbla18SwapInOutSchedulerE">
<span id="_CPPv3N4nbla18SwapInOutSchedulerE"></span><span id="_CPPv2N4nbla18SwapInOutSchedulerE"></span><span id="nbla::SwapInOutScheduler"></span><span class="target" id="classnbla_1_1SwapInOutScheduler"></span><span class="k"><span class="pre">class</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">SwapInOutScheduler</span></span></span><a class="headerlink" href="#_CPPv4N4nbla18SwapInOutSchedulerE" title="Permalink to this definition"></a><br /></dt>
<dd><p>A class which manages GPU memory usage and schedules swap in/out throughout network computation. </p>
<p>If GPU memory is insufficient to train your model, <a class="reference internal" href="../namespace/nbla.html#classnbla_1_1SwapInOutScheduler"><span class="std std-ref">SwapInOutScheduler</span></a> enables you to compute it fast and effectively by using memory swapping strategy.</p>
<p>This class schedules the timing to swap out tensors to avoid out of memory and to swap in them before they are reused in computation.</p>
<p>The schedule is made to be based on the usage order of tensors in the first training iteration. It indicates the disorder of the usage order in the rest iteration will cause speed-down.</p>
<p>A scheduler takes the size of GPU memory which you want to manage. For example, when your GPU memory is up to 4 GB, the initialization is <div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SwapInOutScheduler</span> <span class="n">scheduler</span><span class="p">(</span><span class="n">cpu_ctx</span><span class="p">,</span> <span class="n">gpu_ctx</span><span class="p">,</span> <span class="mf">4e9</span><span class="p">);</span>
</pre></div>
</div>
 If out-of-memory error occurs in this configuration, the gradul reduction of 4e9 could solve the problem; for example, let the next size be 3.5e9.</p>
<p>This scheduler can be used easily as extension by enclosing a training block between <a class="reference internal" href="../namespace/nbla.html#classnbla_1_1SwapInOutScheduler_1a9e3afad9d804f4b52d21939f19e6183b"><span class="std std-ref">SwapInOutScheduler::start_scheduling()</span></a> and <a class="reference internal" href="../namespace/nbla.html#classnbla_1_1SwapInOutScheduler_1a7a6330aa41bdf77bba8ea13d337eb67c"><span class="std std-ref">SwapInOutScheduler::end_scheduling()</span></a>. And also you need set the callback functions into the arguments of forward, backward, and update. For example, in a training loop, <div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">shceduler</span><span class="o">.</span><span class="n">start_scheduling</span><span class="p">();</span>
<span class="o">//</span> <span class="n">Input</span> <span class="nb">next</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">line</span><span class="o">.</span>
<span class="n">loss</span><span class="o">-&gt;</span><span class="n">forward</span><span class="p">(</span><span class="n">false</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">,</span>
              <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">const</span> <span class="n">CgFunctionPtr</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">scheduler</span><span class="o">.</span><span class="n">pre_function_callback</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span> <span class="p">},</span>
              <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">const</span> <span class="n">CgFunctionPtr</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">scheduler</span><span class="o">.</span><span class="n">post_function_callback</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span> <span class="p">});</span>
<span class="n">loss</span><span class="o">-&gt;</span><span class="n">variable</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">grad</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">fill</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
<span class="n">loss</span><span class="o">-&gt;</span><span class="n">backward</span><span class="p">(</span><span class="n">nullptr</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="p">{},</span>
              <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">const</span> <span class="n">CgFunctionPtr</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">scheduler</span><span class="o">.</span><span class="n">pre_function_callback</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span> <span class="p">},</span>
              <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">const</span> <span class="n">CgFunctionPtr</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">scheduler</span><span class="o">.</span><span class="n">post_function_callback</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span> <span class="p">});</span>
<span class="n">adam</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]()</span> <span class="p">{</span> <span class="n">swap_in_out_scheduler</span><span class="o">.</span><span class="n">pre_update_callback</span><span class="p">();</span> <span class="p">},</span>
             <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span> <span class="p">{</span> <span class="n">swap_in_out_scheduler</span><span class="o">.</span><span class="n">post_update_callback</span><span class="p">();</span> <span class="p">});</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">end_scheduling</span><span class="p">();</span>
</pre></div>
</div>
 </p>
<div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric" id="breathe-section-title-public-functions">Public Functions</p>
<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N4nbla18SwapInOutScheduler18SwapInOutSchedulerERK7ContextRK7ContextK6size_tK6size_tKbKb">
<span id="_CPPv3N4nbla18SwapInOutScheduler18SwapInOutSchedulerERK7ContextRK7ContextK6size_tK6size_tKbKb"></span><span id="_CPPv2N4nbla18SwapInOutScheduler18SwapInOutSchedulerERK7ContextRK7ContextK6size_tK6size_tKbKb"></span><span id="nbla::SwapInOutScheduler::SwapInOutScheduler__ContextCR.ContextCR.sC.sC.bC.bC"></span><span class="target" id="classnbla_1_1SwapInOutScheduler_1a55748b674defae1edc44fefd558c0b69"></span><span class="n"><span class="pre">NBLA_API</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">SwapInOutScheduler</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><a class="reference internal" href="nbla--Context.html#_CPPv4N4nbla7ContextE" title="nbla::Context"><span class="n"><span class="pre">Context</span></span></a><span class="w"> </span><span class="p"><span class="pre">&amp;</span></span><span class="n sig-param"><span class="pre">h_ctx</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><a class="reference internal" href="nbla--Context.html#_CPPv4N4nbla7ContextE" title="nbla::Context"><span class="n"><span class="pre">Context</span></span></a><span class="w"> </span><span class="p"><span class="pre">&amp;</span></span><span class="n sig-param"><span class="pre">d_ctx</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="n"><span class="pre">size_t</span></span><span class="w"> </span><span class="n sig-param"><span class="pre">max</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="n"><span class="pre">size_t</span></span><span class="w"> </span><span class="n sig-param"><span class="pre">prefetch_max</span></span><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="m"><span class="pre">0</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="n sig-param"><span class="pre">save_host_mem</span></span><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="k"><span class="pre">true</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="n sig-param"><span class="pre">save_host_mem_no_abort</span></span><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="k"><span class="pre">false</span></span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N4nbla18SwapInOutScheduler18SwapInOutSchedulerERK7ContextRK7ContextK6size_tK6size_tKbKb" title="Permalink to this definition"></a><br /></dt>
<dd><p>Constructor. </p>
<p>h_ctx Host context used as the destination of swap-out.  d_ctx Device context.  max Maximum GPU memory size managed by this class [bytes].  prefetch_max Maximum prefetch length.  save_host_mem The flag to switch prefetch scheme to save host memory.  save_host_mem_no_abort Irregular off-schedule does not abort program if cast prefetch irreversibly change the type of array. </p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp" id="_CPPv4N4nbla18SwapInOutSchedulerD0Ev">
<span id="_CPPv3N4nbla18SwapInOutSchedulerD0Ev"></span><span id="_CPPv2N4nbla18SwapInOutSchedulerD0Ev"></span><span id="nbla::SwapInOutScheduler::~SwapInOutScheduler"></span><span class="target" id="classnbla_1_1SwapInOutScheduler_1a1b15c8a0c64e1950a180207331692710"></span><span class="n"><span class="pre">NBLA_API</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">~SwapInOutScheduler</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N4nbla18SwapInOutSchedulerD0Ev" title="Permalink to this definition"></a><br /></dt>
<dd><p>Destructor. </p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp">
<span class="target" id="classnbla_1_1SwapInOutScheduler_1a9e3afad9d804f4b52d21939f19e6183b"></span><span class="sig-name descname"><span class="pre">NBLA_API</span> <span class="pre">void</span> <span class="pre">start_scheduling</span> <span class="pre">()</span></span></dt>
<dd><p>This initializes the scheduler and starts the management of GPU memory in this iteration. </p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp">
<span class="target" id="classnbla_1_1SwapInOutScheduler_1a7a6330aa41bdf77bba8ea13d337eb67c"></span><span class="sig-name descname"><span class="pre">NBLA_API</span> <span class="pre">void</span> <span class="pre">end_scheduling</span> <span class="pre">()</span></span></dt>
<dd><p>This finalizes the scheduler and stops the management of GPU memory in this iteration. </p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp">
<span class="target" id="classnbla_1_1SwapInOutScheduler_1a5f206f9d58ee9b2403a0169635788857"></span><span class="sig-name descname"><span class="pre">NBLA_API</span> <span class="pre">void</span> <span class="pre">pre_function_callback</span> <span class="pre">(const</span> <span class="pre">CgFunctionPtr</span> <span class="pre">&amp;ptr)</span></span></dt>
<dd><p>To use the scheduler, this callback must be set in the pre-function-hook arguments of forward and backward function. </p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp">
<span class="target" id="classnbla_1_1SwapInOutScheduler_1ad6ae1acb87a51b3d453060961561d16b"></span><span class="sig-name descname"><span class="pre">NBLA_API</span> <span class="pre">void</span> <span class="pre">post_function_callback</span> <span class="pre">(const</span> <span class="pre">CgFunctionPtr</span> <span class="pre">&amp;ptr)</span></span></dt>
<dd><p>To use the scheduler, this callback must be set in the post-function-hook arguments of forward and backward function. </p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp">
<span class="target" id="classnbla_1_1SwapInOutScheduler_1afc5a8fc755e731b6592194345d5aceb0"></span><span class="sig-name descname"><span class="pre">NBLA_API</span> <span class="pre">void</span> <span class="pre">pre_update_callback</span> <span class="pre">()</span></span></dt>
<dd><p>To use the scheduler, this callback must be set in the pre-update-hook argument of the update method of a solver. </p>
</dd></dl>

<dl class="cpp function">
<dt class="sig sig-object cpp">
<span class="target" id="classnbla_1_1SwapInOutScheduler_1a8d3e9055406b717ee3239013998f21a1"></span><span class="sig-name descname"><span class="pre">NBLA_API</span> <span class="pre">void</span> <span class="pre">post_update_callback</span> <span class="pre">()</span></span></dt>
<dd><p>To use the scheduler, this callback must be set in the post-update-hook argument of the update method of a solver. </p>
</dd></dl>

</div>
</dd></dl>

</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="nbla--SumPooling.html" class="btn btn-neutral float-left" title="class nbla::SumPooling" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Swish.html" class="btn btn-neutral float-right" title="class Swish" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Sony Corporation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>